# Smart contract reference
# 智能合约索引
The smart contract source code can be found on [GitHub](https://github.com/88mphapp/88mph-contracts).
智能合约源代码均可在 [GitHub](https://github.com/88mphapp/88mph-contracts)找到。
## Architecture overview
## 体系概览
Each 88mph pool consists of 6 smart contracts:
每个88mph的池子都由六个智能合约搭建而成。
- `DInterest`: The main smart contract that users interact with. Handles depositing, withdrawing, and keeping track of deposits. Emits all of the events used in the subgraph.
- `DInterest`: 用户主要参与互动的条约，功能包括处理存取款信息、跟踪记录存款及发射子节点所使用的所有事件。
- `FeeModel`: Determines the fee strategy of 88mph, as well as who receives the fees.
- `FeeModel`: 决定88mph的酬金策略以及酬金获得者。
- `MoneyMarket`: A wrapper for interacting with yield-generating protocols, and stores all of the user funds. Requires a different one for each protocol.
- `MoneyMarket`:与其他收益平台互动的包装，储存所有用户资金，一个条约仅适用于与一个平台互动。
- `InterestOracle`: An oracle for the interest rate of the underlying yield-generating protocol.
- `InterestOracle`: 预计底层收益平台利率的变化。
- `NFT`: Two non-fungible ERC721 tokens, used for representing ownership of deposits and bonds.
- `NFT`: 根据ERC721标准发行的两种不可替代代币（NFT），是存款或债券所有人的象征。
Globally 88mph has the following contracts for handling things related to the MPH token:
在世界范围内，88mph用以下条约来处理与MPH代币相关的事务。
- `MPHToken`: The MPH ERC-20 token contract itself.
- `MPHMinter`: Responsible for minting & taking back MPH tokens for depositors & bond buyers.
- `Dumper`: Responsible for accumulating the protocol fees & yield-farming rewards generated by 88mph pools and exchanging them for DAI.
- `Rewards`: The MPH rewards staking contract for distributing the protocol fees & yield-farming rewards.
- `MPHToken`:MPH ERC-20代币合约。 
- `MPHMinter`:负责铸币，从储户和债券购买者处收回MPH代币。
- `Dumper`: 负责累加社区服务费及在88mph流动池子里产生的挖矿收益并将收益换成DAI。
- `Rewards`:MPH锁仓挖矿奖励合约，负责分配平台服务费和挖矿收益。

## 应用程序接口索引

### DInterest

#### 状态变换函数

##### `function deposit(uint256 amount, uint256 maturationTimestamp) external`

Creates a single deposit for the caller.
负责为来访者建立一笔单一的存款。
- `amount`: The amount of `stablecoin` to deposit. The caller should have already approved the contract to spend this much `stablecoin` before calling this function. Scaled by \(10^{stablecoinDecimals}\).
- `amount`: 存入的`stablecoin`（稳定币）数量。在访问此功能前，来访者需要认可此条约方能创建如数的存款。计算公式为\(10^{stablecoinDecimals}\)。
- `maturationTimestamp`: The Unix timestamp at and after which the deposit will be able to be withdrawn. In seconds.
- `maturationTimestamp`: Unix时间戳，数秒记录存款时间，失效即期满。
##### `function withdraw(uint256 depositID) external`

Withdraws a single deposit for the caller. The caller must own the deposit NFT with ID `depositID`.
负责为来访者取出一笔单一存款。来访者须持有该笔存款的NFT以及`depositID`。
- `depositID`: The index of the deposit to be withdrawn in the `deposits` array plus 1.
- `depositID`: `deposits`数组中要提取的存款的指数加1。
###### Important note
###### 注意事项

Withdrawing may fail if the 88mph pool has failed to generate enough interest from the underlying money market to cover the deficit incurred by the original upfront interest payout, and no one has funded the difference by buying bonds. This is the main risk of depositing into 88mph.
如果88mph流动池在底层交易市场中无法产生足额利息来偿算承诺给用户的利息，并且也没人买债券来补足差额，那么取款则有可能失败。这是在88mph平台上投资的主要风险。
##### `function earlyWithdraw(uint256 depositID) external`

Withdraws a single deposit for the caller, before the maturation timestamp. The caller must own the deposit NFT with ID `depositID`.
负责未到期的提前取款事宜。来访者须持有该笔存款的NFT以及`depositID`。
- `depositID`: The index of the deposit to be withdrawn in the `deposits` array plus 1.
- `depositID`: `deposits`数组中要提取的存款的指数加1。

##### `function multiDeposit(uint256[] calldata amountList, uint256[] calldata maturationTimestampList) external`

Deposits multiple deposits for the caller. The values at each index in each array will be combined to create a single deposit.
负责为来访者存入多笔存款。每个数组中每个索引的值将被合并以创建单个存款。
- `amountList`: An array of the amounts of `stablecoin` to deposit. The caller should have already approved the contract to spend this much `stablecoin` before calling this function. Scaled by \(10^{stablecoinDecimals}\).
- `amountList`：要存入的`stablecoin`（稳定币）数量的数组。在访问此功能前，来访者需要认可此条约方能创建如数的存款。 计算公式为\(10^{stablecoinDecimals}\)。
- `maturationTimestampList`: An array of the Unix timestamps at and after which the deposits will be able to be withdrawn. In seconds.
- `maturationTimestampList`:Unix时间戳数组，数秒记录存款时间，失效即期满。

###### Input size limit
###### 输入大小限制

The maximum recommended number of deposits is 20.
建议的最大存款数为20。
##### `function multiWithdraw(uint256[] calldata depositIDList) external`

Withdraws multiple deposits for the caller. The caller must own the deposit NFTs with IDs in `depositIDList`.
负责为来访者取出多笔存款。来访者须持有该笔存款的NFT以及`depositIDList`。

- `depositIDList`: The indices of the deposits to be withdrawn in the `deposits` array plus 1.
- `depositIDList`：`deposits`数组中要提取的各笔存款的指数加1。

###### Input size limit
###### 输入大小限制

The maximum recommended number of deposits is 100.
建议的最大存款数为100。

###### Important note

Withdrawing may fail if the 88mph pool has failed to generate enough interest from the underlying money market to cover the deficit incurred by the original upfront interest payout, and no one has funded the difference. This is the main risk of depositing into 88mph. If withdrawing actually fails, `earlyWithdraw()` may be called to get back the deposit minus the upfront interest and fee.
如果88mph流动池在底层交易市场中无法产生足额利息来偿算承诺给用户的利息，并且也没人买债券来补足差额，那么取款则有可能失败。这是在88mph平台上投资的主要风险。如果取款失败，`earlyWithdraw()`程序可能被唤醒从本金中扣除前一阶段的利息和费用。

##### `function multiEarlyWithdraw(uint256[] calldata depositIDList) external`

Withdraws multiple deposits for the caller, before the maturation timestamp. The caller must own the deposit NFTs with IDs in `depositIDList`.
负责在存期未满时为来访者取出多笔存款。来访者须持有该笔存款的NFT以及`depositIDList`。

- `depositIDList`: The indices of the deposits to be withdrawn in the `deposits` array plus 1.
- `depositIDList`: `deposits`数组中要提取的各笔存款的指数加1。

###### Input size limit
###### 输入大小限制

The maximum recommended number of deposits is 50.
建议的最大存款数为50。

##### `function fundAll() external`

Allows the caller to fund all of the existing deficit of the 88mph pool. In exchange, the caller receives a funding NFT, and the interest generated by the deposits the caller funded will be sent to the owner of the NFT whenever a deposit they funded is withdrawn.


Before calling this function, the caller must approve at least the deficit amount of `stablecoin` to the `DInterest` contract. This amount may be obtained using [`surplus()`](#function-surplus-external-view-returns-bool-isnegative-uint256-surplusamount). To avoid the transaction being reverted, it is recommended to simply set the approval amount to \(2^{256}-1\).

##### `function fundMultiple(uint256 toDepositID) external`

Allows the caller to fund the deficit of multiple deposits. In exchange, the caller receives a funding NFT, and the interest generated by the deposits the caller funded will be sent to the owner of the NFT whenever a deposit they funded is withdrawn.

Before calling this function, the caller must approve at least the deficit amount of `stablecoin` to the `DInterest` contract. This amount may be obtained using [`surplusOfDeposit()`](#function-surplusofdeposituint256-depositid-external-view-returns-bool-isnegative-uint256-surplusamount). To avoid the transaction being reverted, it is recommended to simply set the approval amount to \(2^{256}-1\).

- `toDepositID`: Deposits with ID from (not including) `lastFundedDepositID` to (including) `toDepositID` will be funded.

#### Read only functions

##### `function getDeposit(uint256 depositID) external view returns (uint256 amount, uint256 maturationTimestamp, uint256 initialDeficit, uint256 initialMoneyMarketIncomeIndex, bool active)`

Returns info about a user deposit. The owner of the deposit is whichever Ethereum account that owns the ERC721 deposit token with id `depositID`.

###### Inputs

- `depositID`: The index of the deposit in the `deposits` array.

###### Returns

- `amount`: The amount of the deposit, in stablecoins. Scaled by \(10^{stablecoinDecimals}\).
- `maturationTimestamp`: The Unix timestamp at and after which the deposit will be able to be withdrawn. In seconds.
- `interestOwed`: The initial debt caused by the deposit.
- `initialMoneyMarketIncomeIndex`: The value returned by [`moneyMarket.incomeIndex()`](#function-incomeIndex-external-returns-uint256) at the time of deposit.
- `active`: `true` if the deposit hasn't been withdrawn, `false` otherwise.
- `finalSurplusIsNegative`: `true` if at the time of withdrawal the deposit had a negative surplus, `false` otherwise.
- `finalSurplusAmount`: The amount of surplus/debt of the deposit at the time of withdrawal.
- `mintMPHAmount`: The amount of MPH tokens minted to the user at the time of deposit.

##### `function getFunding(uint256 fundingID) external view returns (uint256 fromDepositID, uint256 toDepositID, uint256 recordedFundedDepositAmount, uint256 recordedMoneyMarketIncomeIndex)`

Returns info about a funding. The owner of the funding (and the account who will receive the interests) is whichever Ethereum account that owns the ERC721 funding token with id `fundingID`.

###### Inputs

- `fundingID`: The index of the funding in the `fundingList` array.

###### Returns

- `fromDepositID`: Deposits with ID from (not including) `fromDepositID` to (including) `toDepositID` have their deficits funded by this funding instance.
- `toDepositID`: Deposits with ID from (not including) `fromDepositID` to (including) `toDepositID` have their deficits funded by this funding instance.
- `recordedFundedDepositAmount`: The current total deposit amount that is generating interest for the owner of this funding instance, in stablecoins. Scaled by \(10^{stablecoinDecimals}\).
- `recordedMoneyMarketIncomeIndex`: The value returned by [`moneyMarket.incomeIndex()`](#function-incomeIndex-external-returns-uint256) at the time of the latest withdrawal of a deposit funded by this funding instance. If no funded deposit has been withdrawn yet, this value is equal to the monet market incomeIndex at the time of the funding instance's creation.

##### `function MinDepositPeriod() external view returns (uint256)`

Returns the minimum deposit period, in seconds.

##### `function MaxDepositPeriod() external view returns (uint256)`

Returns the maximum deposit period, in seconds.

##### `function MinDepositAmount() external view returns (uint256)`

Returns the minimum deposit amount for a single deposit in `stablecoin`. Scaled by \(10^{stablecoinDecimals}\).

##### `function MaxDepositAmount() external view returns (uint256)`

Returns the maximum deposit amount for a single deposit in `stablecoin`. Scaled by \(10^{stablecoinDecimals}\).

##### `function totalDeposit() external view returns (uint256)`

Returns the total deposited amount of `stablecoin`. Scaled by \(10^{stablecoinDecimals}\).

##### `function moneyMarket() external view returns (address)`

Returns the address of `MoneyMarket`.

##### `function stablecoin() external view returns (address)`

Returns the address of the stablecoin used.

##### `function feeModel() external view returns (address)`

Returns the address of `FeeModel`.

##### `function interestModel() external view returns (address)`

Returns the address of `InterestModel`.

##### `function interestOracle() external view returns (address)`

Returns the address of `InterestOracle`.

##### `function depositNFT() external view returns (address)`

Returns the address of the ERC721 deposit token.

##### `function fundingNFT() external view returns (address)`

Returns the address of ERC721 funding token.

##### `function calculateInterestAmount(uint256 depositAmount, uint256 depositPeriodInSeconds) external view returns (uint256 interestAmount)`

Returns the interest amount given the deposit amount and period.

###### Inputs

- `depositAmount`: The amount of the deposit in `stablecoin`. Scaled by \(10^{stablecoinDecimals}\).
- `depositPeriodInSeconds`: The length of the deposit's deposit period, in seconds.

##### `function surplus() external view returns (bool isNegative, uint256 surplusAmount)`

Returns the surplus value of the pool over the owed deposits.

###### Returns

- `isNegative`: Whether the surplus is negative. A negative surplus means there's a deficit.
- `surplusAmount`: Amount of the pool's surplus, in stablecoins. Scaled by \(10^{stablecoinDecimals}\).

##### `function surplusOfDeposit(uint256 depositID) external view returns (bool isNegative, uint256 surplusAmount)`

Returns the surplus value of a particular deposit. Does not include funding.

###### Inputs

- `depositID`: The index of the deposit to be withdrawn in the `deposits` array plus 1.

###### Returns

- `isNegative`: Whether the surplus is negative. A negative surplus means there's a deficit.
- `surplusAmount`: Amount of the pool's surplus, in stablecoins. Scaled by \(10^{stablecoinDecimals}\).

##### `function depositsLength() external view returns (uint256)`

Returns the length of the `deposits` array.

##### `function fundingListLength() external view returns (address)`

Returns the length of the `fundingList` array.

##### `function depositIsFunded(uint256 depositID) external view returns (bool)`

###### Inputs

- `depositID`: The index of the deposit to be withdrawn in the `deposits` array plus 1.

###### Returns

Returns whether or not the deposit's deficit has been funded.

##### `function latestFundedDepositID() external view returns (uint256)`

Returns the maximum ID among funded deposits. It can be assumed that all deposits with ID less than or equal to this value have been funded.

##### `function unfundedUserDepositAmount() external view returns (uint256)`

Returns the deposited `stablecoin` amount whose deficit hasn't been funded. Scaled by \(10^{stablecoinDecimals}\).

### FeeModel

#### Read only functions

##### `function getFee(uint256 _txAmount) external pure returns (uint256 _feeAmount)`

Used for determining how much fee to charge from a transaction.

###### Inputs

- `_txAmount`: The amount of the transaction from which a fee will be taken.

###### Returns

- `_feeAmount`: The amount of the fee that will be taken from the transaction.

##### `function beneficiary() external view returns (address)`

Returns the address who will receive the fees.

### MoneyMarket

#### State changing functions

##### `function deposit(uint256 amount) external`

Lends `amount` stablecoins to the underlying money market protocol.

###### Inputs

- `amount`: The amount of stablecoins to be deposited.

##### `function withdraw(uint256 amountInUnderlying) external`

Withdraws `amountInUnderlying` stablecoins from the underlying money market protocol.

###### Inputs

- `amountInUnderlying`: The amount of stablecoins to be withdrawn.

#### Read only functions

##### `function totalValue() external returns (uint256)`

Returns the total value locked in the money market, in terms of the underlying stablecoin. Scaled by \(10^{stablecoinDecimals}\).

##### `function incomeIndex() external returns (uint256)`

Returns an index that can be used to compute the interest generated by the money market over a period of time. Specifically, \(interestOverPeriod = depositValueAtBeginningOfPeriod \times \frac{incomeIndexAtEndOfPeriod}{incomeIndexAtBeginningOfPeriod}\).
